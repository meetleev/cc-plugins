var ccx=function(t,n){"use strict";var i=!0,r=function(){function t(){}return t.l=function(){if("object"==typeof console&&console.log){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];n.unshift("[ccx debug]-> "),i&&console.log.apply(console,n)}},t.i=function(){if("object"==typeof console&&console.info){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];n.unshift("[ccx info]-> "),i&&console.info.apply(console,n)}},t.w=function(){if("object"==typeof console&&console.warn){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];n.unshift("[ccx warning]-> "),i&&console.warn.apply(console,n)}},t.e=function(){if("object"==typeof console&&console.error){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];n.unshift("[ccx error]-> "),i&&console.error.apply(console,n)}},t.setDebug=function(t){i=t},t}(),o=function(){function t(t,n,i){this.t=new Map,this.o=t,this.addListener(i,n)}var n=t.prototype;return n.getTarget=function(){return this.o},n.getListener=function(t){return this.t.get("$"+t)},n.addListener=function(t,n){null==this.getListener(t)&&this.t.set("$"+t,n)},n.removeListener=function(t){this.t.delete("$"+t)},t}(),e=function(){function t(){}var n=t.prototype;return n.on=function(t,n,i){this.t=this.t||[];var r=this.hasEventListener(t);r&&r.getListener(i)||(r?r.addListener(i,n):(r=new o(t,n,i),this.t.push(r)))},n.hasEventListener=function(t){if(!t)return null;this.t=this.t||[];for(var n=0,i=this.t;n<i.length;n++){var r=i[n];if(t===r.getTarget())return r}return null},n.emit=function(t){this.t=this.t||[];for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,e=this.t;o<e.length;o++){var u=e[o],s=u.getListener(t);s&&s.apply(u.getTarget()||this,i)}},n.off=function(t,n){if(t){var i=this.hasEventListener(t);i&&i.removeListener(n)}},n.removeAll=function(t){if(t){this.t=this.t||[];var n=0;for(this.t.length;n<this.t.length;)t===this.t[n].getTarget()?this.t.splice(n,1):n++}},t}(),u=new e,s=new(function(){function t(){this.resHash=new Map,this.resHash.clear()}var i=t.prototype;return i.loadTiledMap=function(t,i){return null!=i||(i="tiledMaps"),this.load(n.TiledMapAsset,i+"/"+t)},i.loadAudio=function(t,i){return null!=i||(i="audios"),this.load(n.AudioClip,i+"/"+t)},i.loadPrefab=function(t,i){return null!=i||(i="prefabs"),this.load(n.Prefab,i+"/"+t)},i.loadTexture=function(t,i){return null!=i||(i="textures"),this.load(n.Texture2D,i+"/"+t+"/texture")},i.loadSpriteFrame=function(t,i){var r=this;return null!=i||(i="textures"),new Promise((function(o,e){r.load(n.SpriteFrame,i+"/"+t+"/spriteFrame",!0).then((function(t){return o(t)})).catch((function(){r.loadTexture(t).then((function(t){return o(n.SpriteFrame.createWithImage(t.image))})).catch((function(t){return e(t)}))}))}))},i.loadMaterial=function(t,i){return null!=i||(i="materials"),this.load(n.Material,i+"/"+t)},i.loadSkeletonData=function(t,i){return new Promise((function(r,o){null!=i||(i="spines"),n.resources.load(i+"/"+t,n.sp.SkeletonData,(function(n,i){n&&console.log("loadSpine err ",n,"spines/"+t),n?o(n):r(i)}))}))},i.load=function(t,i,r){var o=this;return void 0===r&&(r=!1),new Promise((function(e,u){var s=o.resHash.get(i);void 0!==s?e(s):n.resources.load(i,t,(function(n,s){n?(!r&&console.log("load err ",n,"type = "+t+" paths = "+i),u(n)):(o.resHash.set(s.name,s),e(s))}))}))},t}());function c(t,n){for(var i=0;i<n.length;i++){var r=n[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function f(t,n,i){return n&&c(t.prototype,n),i&&c(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function h(t,n){return h=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t},h(t,n)}var l,a=function(t){var n,i;function r(){for(var n,i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];return(n=t.call.apply(t,[this].concat(r))||this).u=[],n.h=[],n}i=t,(n=r).prototype=Object.create(i.prototype),n.prototype.constructor=n,h(n,i);var o=r.prototype;return o.schedule=function(t){"function"==typeof t?this.h.push(t):this.u.push(t)},o.update=function(t){for(var n=this.u,i=0,r=n.length;i<r;){var o=n[i];0>=o.duration?(o.onEnd(),this.u.splice(i,1),r--):(i++,o.duration-=t)}for(var e=this.h,u=0,s=e.length;u<s;)(0,e[u])(t)?(this.h.splice(u,1),s--):u++},r}(n.Component),v="ccx@MusicEnabled",d="ccx@EffectEnabled";!function(t){t[t.BGMusic=0]="BGMusic",t[t.Music=1]="Music",t[t.Effect=2]="Effect"}(l||(l={}));var w=function(){function t(){var i;this.commonAudioSources=[],this.musicAudioSourceMap=new Map,this.maxCommonAudioNums=10,this.v=!1,this.p=!1,this.g=!1,n.director.on(n.Director.EVENT_BEFORE_SCENE_LAUNCH,(function(){delete t.instance,t.instance=void 0})),this.P=new n.Node("audio"),null==(i=n.director.getScene())||i.addChild(this.P),this.S=this.P.addComponent(a);for(var r=0;r<this.maxCommonAudioNums;r++)this.commonAudioSources.push(this.createAudio());this.bgAudioSource=this.createAudio(!0);var o=n.sys.localStorage.getItem(v);this.v="0"!=o,o=n.sys.localStorage.getItem(d),this.p="0"!=o}var i=t.prototype;return i.playBGMusic=function(i,r,o){var e=this;void 0===r&&(r=!0),void 0===o&&(o=1),i instanceof n.AudioClip?this.play(l.BGMusic,i,o,r):t.loadAudio(i).then((function(t){e.play(l.BGMusic,t,o,r)}))},i.playMusic=function(i,r,o){var e=this;void 0===r&&(r=!0),void 0===o&&(o=1),i instanceof n.AudioClip?this.play(l.Music,i,o,r):t.loadAudio(i).then((function(t){e.play(l.Music,t,o,r)}))},i.playEffect=function(i,r){var o=this;void 0===r&&(r=1),i instanceof n.AudioClip?this.play(l.Effect,i,r):t.loadAudio(i).then((function(t){o.play(l.Effect,t,r)}))},i.pauseAllMusic=function(){var t;null==(t=this.bgAudioSource)||t.stop(),Array.from(this.musicAudioSourceMap.values()).forEach((function(t){return t.stop()}))},i.pauseMusic=function(t,n){var i,r;if(this.bgAudioSource&&(null==(r=this.bgAudioSource.clip)?void 0:r.name)==t&&(i=this.bgAudioSource),i=this.musicAudioSourceMap.get(t))if(n){var o=i.volume;this.S.schedule((function(t){return i.volume-=t,i.volume<=.1&&(i.stop(),i.volume=o,!0)}))}else i.stop()},i.resumeBGMusic=function(){var t;this.v&&(null==(t=this.bgAudioSource)||t.play())},i.resumeAllMusic=function(){var t;this.v&&(null==(t=this.bgAudioSource)||t.play(),Array.from(this.musicAudioSourceMap.values()).forEach((function(t){return t.play()})))},i.destroyMusic=function(t){var n;if(this.bgAudioSource&&(null==(n=this.bgAudioSource.clip)?void 0:n.name)==t&&(this.bgAudioSource.stop(),this.bgAudioSource.clip.destroy(),this.bgAudioSource.clip=null),this.musicAudioSourceMap.has(t)){var i=this.musicAudioSourceMap.get(t);null==i||i.stop(),null==i||i.destroy(),this.musicAudioSourceMap.delete(t)}},i.destroyMusicExceptBg=function(){Array.from(this.musicAudioSourceMap.values()).forEach((function(t){return t.destroy()})),this.musicAudioSourceMap.clear()},i.play=function(t,n,i,r){switch(t){case l.BGMusic:!this.adPlaying&&this.v?(this.bgAudioSource.stop(),this.bgAudioSource.clip=n,r&&(this.bgAudioSource.loop=r),this.bgAudioSource.volume=i,this.bgAudioSource.playOnAwake=!0,this.bgAudioSource.play()):(this.bgAudioSource.clip=n,this.bgAudioSource.stop());break;case l.Music:var o,e;this.musicAudioSourceMap.has(n.name)?e=this.musicAudioSourceMap.get(n.name):((e=this.createAudio(r)).clip=n,this.musicAudioSourceMap.set(n.name,e)),!this.adPlaying&&this.v?(e.volume=i,e.playOnAwake=!0,e.play()):null==(o=e)||o.stop();break;case l.Effect:if(!this.adPlaying&&this.p){var u=this.getFreeCommonAudioSource();u.volume=i,u.playOneShot(n)}}},i.getFreeCommonAudioSource=function(){for(var t=0,n=this.commonAudioSources.length;t<n;t++){var i=this.commonAudioSources[t];if(!i.playing)return i}var r=this.createAudio();return this.commonAudioSources.push(r),r},i.createAudio=function(t){var i=this.P.addComponent(n.AudioSourceComponent);return t&&(i.loop=t),i.volume=1,i.playOnAwake=!1,i},t.loadAudio=function(t){return s.loadAudio(t)},f(t,[{key:"musicEnabled",get:function(){return this.v},set:function(t){this.v!=t&&(this.v=t,t?this.resumeAllMusic():this.pauseAllMusic(),n.sys.localStorage.setItem(v,this.v?"1":"0"))}},{key:"effectEnabled",get:function(){return this.p},set:function(t){this.p!=t&&(this.p=t,n.sys.localStorage.setItem(d,this.p?"1":"0"))}},{key:"adPlaying",get:function(){return this.g},set:function(t){this.g!=t&&(this.g=t,this.g?this.pauseAllMusic():this.resumeAllMusic())}}],[{key:"Instance",get:function(){return null==t.instance&&(t.instance=new t),t.instance}}]),t}(),y=function(){function t(){var t=this;this.uiTypeNodeMap=new Map,this.uiTypes=new Set,this.B=n.Size.ZERO,n.director.on(n.Director.EVENT_BEFORE_SCENE_LAUNCH,(function(){t.uiRoot=void 0,t.canvas=void 0,t.uiTypes.clear(),t.uiTypeNodeMap.clear()}))}var i=t.prototype;return i.getCanvas=function(){var t=n.director.getScene();if(t)for(var i=t.children,r=0,o=i.length;r<o;r++){var e=i[r],u=e.getComponent(n.Canvas);if(u)return this.canvas=u.node,e}return null},i.createUI=function(t,i){var r=this;return new Promise((function(o,e){s.loadPrefab("ui/"+i).then((function(i){var e,u=n.instantiate(i),s=null!=r.uiRoot?r.uiRoot:r.getCanvas();null==(e=null!=s?s:n.director.getScene())||e.addChild(u),null==u.N.uiTransformComp&&(u.N.uiTransformComp=u.addComponent(n.UITransform)),u.N.uiTransformComp.contentSize=n.view.getVisibleSize(),r.uiTypeNodeMap.set(t,u),o(u)})).catch((function(t){e(t)}))}))},i.getNode=function(t){var n=this;return new Promise((function(i,r){n.uiTypeNodeMap.has(t)?i(n.uiTypeNodeMap.get(t)):r("no uiNode or uiNode loading!")}))},i.show=function(t,n){return this.uiTypes.has(t)||(this.uiTypes.add(t),null==n)?this.getNode(t):"string"==typeof n?this.createUI(t,n):(this.uiTypeNodeMap.set(t,n),this.getNode(t))},i.hide=function(t){var n=this;return new Promise((function(i,r){n.uiTypes.has(t)?n.uiTypeNodeMap.has(t)?i(n.uiTypeNodeMap.get(t)):r("no uiNode or uiNode loading!"):r("no uiType...")}))},f(t,[{key:"winSize",get:function(){return this.B.equals(n.Size.ZERO)&&(this.B=n.view.getVisibleSize()),this.B}}],[{key:"Instance",get:function(){return null==t.instance&&(t.instance=new t),t.instance}}]),t}(),p=function(){function t(){this.U=new Map}var i=t.prototype;return i.getObjectFromPool=function(t){if(this.U.has(t)){var i,r=this.U.get(t);if(r){var o=r.get();return 0==r.size()&&(n.log("pool get out",t),o&&r.put(n.instantiate(o))),o}return null==(i=this.U.get(t))?void 0:i.get()}return null},i.initObjectToPool=function(t,i,r){for(var o=0;o<r;o++)this.putObjectToPool(t,n.instantiate(i))},i.putObjectToPool=function(t,i){var r,o;this.U.has(t)?o=this.U.get(t):(o=new n.NodePool,this.U.set(t,o)),i&&(null==(r=o)||r.put(i))},i.clearObjectPool=function(t){var n;this.U.has(t)&&(null==(n=this.U.get(t))||n.clear())},f(t,null,[{key:"Instance",get:function(){return null==t.instance&&(t.instance=new t),t.instance}}]),t}(),g=function(){function t(){}return t.isWeiXin=function(){return n.sys.platform===n.sys.Platform.WECHAT_GAME},t.isFB=function(){return"undefined"!=typeof FBInstant},t.isIOS=function(){return n.sys.os===n.sys.OS.IOS},t.isDesktop=function(){return n.sys.platform===n.sys.Platform.DESKTOP_BROWSER},t.isWeb=function(){return n.sys.isBrowser&&"undefined"==typeof FBInstant},t.is3DTouchCompat=function(){return t.isIOS()},t}(),x=function(){function t(){this.m=0,this.k=n.Size.ZERO,this.init()}var i=t.prototype;return i.init=function(){this.k=n.view.getVisibleSize(),this.m=this.k.height/this.k.width,g.isFB()&&!g.isDesktop()&&window.screen&&window.screen.height&&window.screen.width&&(this.m=window.screen.height/window.screen.width),this.isFBNavBarOverlay()&&(this.k.set(this.k.width,this.k.height-96),r.w("[ScreenUtils] Navigation bar is overlay"))},i.isQuanMian=function(){return 1.789<this.m&&this.m<19/9},i.isLiuHai=function(){return this.m>=19/9},i.isPuTong=function(){return this.m<=1.789},i.isFBNavBarOverlay=function(){if(!g.isFB())return!1;var t=Math.floor(this.viewSize.width/window.screen.width*window.screen.height-this.viewSize.height);return this.isQuanMian()||this.isPuTong()?0==t:t<96},i.getOffset=function(){return this.isFBNavBarOverlay()?96:0},i.toLeftByPer=function(t,i){if(void 0===i&&(i=0),null==t)return r.w("[ScreenUtils] toLeftByPer pNode error");var o=t.getComponent(n.Widget)||t.addComponent(n.Widget);o.isAlignLeft=!0,o.left=i*this.viewSize.width/100},i.toLeftByPx=function(t,i,o){if(void 0===i&&(i=0),void 0===o&&(o=!0),null==t)return r.w("[ScreenUtils] toLeftByPx pNode error");var e=t.getComponent(n.Widget);e||(e=t.addComponent(n.Widget),o&&r.w("[ScreenUtils] toLeftByPx do not effect on relative, please you add widget on editor")),e.isAlignLeft=!0,o?e.left+=i:e.left=i},i.toRightByPer=function(t,i){if(void 0===i&&(i=0),null==t)return r.w("[ScreenUtils] toRightByPer pNode error");var o=t.getComponent(n.Widget)||t.addComponent(n.Widget);o.isAlignRight=!0,o.right=i*this.viewSize.width/100},i.toRightByPx=function(t,i,o){if(void 0===i&&(i=0),void 0===o&&(o=!0),null==t)return r.w("[ScreenUtils] toRightByPx pNode error");var e=t.getComponent(n.Widget);e||(e=t.addComponent(n.Widget),o&&r.w("[ScreenUtils] toRightByPx do not effect on relative, please you add widget on editor")),e.isAlignRight=!0,o?e.right+=i:e.right=i},i.toTopByPer=function(t,i){if(void 0===i&&(i=0),null==t)return r.w("[ScreenUtils] toTopByPer pNode error");var o=t.getComponent(n.Widget)||t.addComponent(n.Widget);o.isAlignTop=!0,o.top=i*this.viewSize.height/100},i.toTopByPx=function(t,i,o){if(void 0===i&&(i=0),void 0===o&&(o=!0),null==t)return r.w("[ScreenUtils] toTopByPx pNode error");var e=t.getComponent(n.Widget);e||(e=t.addComponent(n.Widget),o&&r.w("[ScreenUtils] toTopByPx do not effect on relative, please you add widget on editor")),e.isAlignTop=!0,o?e.top+=i:e.top=i},i.updateWidget=function(t){if(null==t)return r.w("[ScreenUtils] updateWidget pNode error");var i=t.getComponent(n.Widget);i&&i.updateAlignment()},i.toFixTopByPx=function(t,i){if(void 0===i&&(i=0),null==t)return r.w("[ScreenUtils] toFixTopByPx pNode error");var o=t.getComponent(n.Widget)||t.addComponent(n.Widget);o.isAlignTop=!0,o.top=this.getOffset()+i},i.toBottomByPx=function(t,i,o){if(void 0===i&&(i=0),void 0===o&&(o=!0),null==t)return r.w("[ScreenUtils] toBottomByPx pNode error");var e=t.getComponent(n.Widget);e||(e=t.addComponent(n.Widget),o&&r.w("[ScreenUtils] toBottomByPx do not effect on relative, please you add widget on editor")),e.isAlignBottom=!0,o?e.bottom+=i:e.bottom=i},i.toBottomByPer=function(t,i){if(void 0===i&&(i=0),null==t)return r.w("[ScreenUtils] toBottomByPer pNode error");var o=t.getComponent(n.Widget)||t.addComponent(n.Widget);o.isAlignBottom=!0,o.bottom=i*this.viewSize.height/100},i.toTopWithOffset=function(t,i,o){if(void 0===i&&(i=0),void 0===o&&(o=0),null==t)return r.w("[ScreenUtils] toTopWithOffset pNode error");var e=t.getComponent(n.Widget)||t.addComponent(n.Widget);e.isAlignTop=!0,e.top=i*this.viewSize.height/100+o},f(t,[{key:"viewSize",get:function(){return this.k}}],[{key:"Instance",get:function(){return null==t.instance&&(t.instance=new t),t.instance}}]),t}();return t.AudioMgr=w,t.EventManager=e,t.Log=r,t.ObjectPoolsMgr=p,t.PlatformUtils=g,t.ScreenUtils=x,t.UIMgr=y,t.eventManager=u,t.resMgr=s,t}({},cc);
